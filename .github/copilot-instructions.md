# GitHub Copilot Instructions for school.epi.abm

## Project Overview

`school.epi.abm` is an R package that implements an agent-based model of infectious disease epidemic and mitigation dynamics in K-6 schools. The model simulates COVID-19 infection spread and the effects of various mitigation strategies (testing, cohorting, masking, etc.) in elementary school settings.

The package is published at <https://ucla-php.github.io/school.epi.abm/> and implements methods described in: https://doi.org/10.3389/fpubh.2023.1856940

## Technology Stack

- **Language**: R (version 4.0+)
- **Package System**: Standard R package structure with roxygen2 documentation
- **UI Framework**: Shiny with shinydashboard for the web application
- **Testing**: testthat (if applicable)
- **Code Style**: tidyverse style guide
- **CI/CD**: GitHub Actions workflows
- **Version Control**: Git/GitHub
- **Dependency Management**: renv for reproducible package environments

## Development Setup

### Prerequisites

1. R (version 4.0 or later recommended)
2. RStudio (optional but recommended)
3. pandoc (for building vignettes and documentation)

### Installation

To install development dependencies:

```r
# Install devtools if not already installed
install.packages("devtools")

# Activate renv environment (if not auto-activated)
renv::restore()

# Install package dependencies
devtools::install_deps(dependencies = TRUE)
```

### Key Dependencies

The package imports:
- `dplyr`, `magrittr`, `purrr` - data manipulation
- `ggplot2`, `plotly`, `scales`, `RColorBrewer` - visualization
- `shiny`, `shinydashboard` - web application framework
- `lubridate` - date handling
- `golem` - Shiny app framework
- `config` - configuration management
- `conflicted` - namespace conflict resolution

## Build, Test, and Lint Commands

### Building the Package

```r
# Build package documentation
devtools::document()

# Install and reload package
devtools::load_all()

# Check package (equivalent to R CMD check)
devtools::check()
```

### Running Tests

```r
# Run all tests (if tests exist)
devtools::test()

# Run specific test file
testthat::test_file("tests/testthat/test-simulation.R")
```

### Linting

```r
# Lint the entire package
lintr::lint_package()

# Lint a specific file
lintr::lint("R/run_simulation.R")
```

### Spell Checking

```r
# Run spell check
spelling::spell_check_package()
```

## Code Style and Conventions

### General Guidelines

1. **Follow tidyverse style guide**: Use the tidyverse style guide for R code
2. **Use roxygen2 for documentation**: All exported functions must have roxygen2 documentation with `@param`, `@return`, `@examples`, and `@export` tags
3. **Use pipe operators**: Prefer the native R pipe (`|>`) or magrittr pipe (`%>%`) for data manipulation
4. **Explicit imports**: Use explicit imports in NAMESPACE via roxygen2 `@importFrom` tags
5. **Handle conflicts**: Use `conflicted` package to explicitly resolve namespace conflicts

### Naming Conventions

- **Functions**: Use snake_case (e.g., `run_simulation`, `initialize_agents`)
- **Variables**: Use snake_case (e.g., `student_records`, `infection_probability`)
- **Constants**: Use descriptive names in UPPER_CASE when appropriate
- **Private functions**: Not exported; document with `#' @keywords internal` if needed

### Documentation Standards

- All exported functions must have complete roxygen2 documentation
- Include `@references` for published methods when applicable
- Include `@examples` that demonstrate function usage
- Document all parameters with `@param`
- Describe return values with `@return`
- Use markdown in roxygen2 comments (set `Roxygen: list(markdown = TRUE)` in DESCRIPTION)

### Code Organization

```
school.epi.abm/
├── R/                          # R source code
│   ├── run_simulation.R       # Main simulation function
│   ├── initialize_agents.R    # Agent initialization
│   ├── initialize_classes.R   # Class setup
│   ├── app_*.R                # Shiny app components
│   ├── plot*.R                # Plotting functions
│   └── school.epi.abm-package.R # Package-level documentation
├── man/                        # Generated documentation (don't edit directly)
├── tests/                      # Test files
│   └── testthat/              # testthat files
├── vignettes/                 # Package vignettes
├── inst/                      # Installed files
│   └── extdata/               # External data files
├── data/                      # Package datasets
├── .github/                   # GitHub configuration
│   └── workflows/             # CI/CD workflows
├── renv/                      # renv configuration (don't edit manually)
├── DESCRIPTION                # Package metadata
├── NAMESPACE                  # Generated by roxygen2 (don't edit directly)
├── README.Rmd                 # Source for README.md
└── app.R                      # Shiny app entry point
```

## Agent-Based Model Structure

The model simulates:
- **Agents**: Students, teachers, and staff members in elementary schools
- **Interactions**: Within-class, close contact groups, and household transmission
- **Interventions**: Testing protocols, cohorting strategies, mask usage, quarantine policies
- **Outcomes**: Infection rates, outbreak dynamics, days of instruction lost

### Key Simulation Components

1. **Initialization**: `initialize_agents()`, `initialize_classes()`
2. **Main Loop**: `run_simulation()` - executes daily infection dynamics
3. **Transmission**: Models infection probability based on contact patterns and mitigation strategies
4. **Testing & Quarantine**: Implements testing schedules and quarantine rules
5. **Outputs**: Daily records of infections, quarantines, and other metrics

## Shiny Application

The package includes a Shiny dashboard for interactive simulation:

### Running the App

```r
# From package root
shiny::runApp()

# Or using the package function
school.epi.abm::run_app()
```

### App Structure

- `app.R` - Main entry point
- `R/app_ui.R` - User interface definition
- `R/app_server.R` - Server logic
- `R/app_config.R` - Configuration handling
- `R/inputs_sidebar.R` - Input controls
- `R/plot1_plotly.R`, `R/plot2.R` - Visualization components

## CI/CD Workflows

The repository uses GitHub Actions for continuous integration:

1. **R-CMD-check** (`.github/workflows/R-CMD-check.yaml`): Runs R CMD check on multiple platforms
2. **lint** (`.github/workflows/lint.yaml`): Runs lintr::lint_package()
3. **pkgdown** (`.github/workflows/pkgdown.yaml`): Builds and deploys package website

All workflows run on push to main branch and on pull requests.

## Important Notes

### Working with Dates

- Use `lubridate` for date operations
- Dates are typically represented as Date objects
- Time periods use numeric day counts

### Reproducibility

- The package uses `renv` for dependency management
- `renv.lock` file tracks all package versions
- Use `renv::restore()` to install exact versions specified in lockfile
- Use `renv::snapshot()` after adding new dependencies

### Data Structures

The simulation produces data frames with:
- **Agent records**: Individual-level infection status, quarantine, testing
- **Class records**: Class-level aggregates 
- **Daily summaries**: Time series of key metrics

### Making Changes

- Always run `devtools::document()` after modifying roxygen2 comments
- Run `devtools::check()` before submitting changes
- Update README.Rmd (not README.md directly) if changing documentation
- Update `renv.lock` with `renv::snapshot()` if adding dependencies
- Maintain backward compatibility for exported functions
- Test the Shiny app after making changes to simulation code

## Getting Help

- Project URL: https://ucla-php.github.io/school.epi.abm/
- GitHub: https://github.com/UCLA-PHP/school.epi.abm
- Contact: demorrison@ucdavis.edu
- Reference paper: https://doi.org/10.3389/fpubh.2023.1856940
